<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donn√©es Capteurs - Temps R√©el</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.8em;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .stat-box h3 {
      font-size: 0.9em;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    
    .stat-box .value {
      font-size: 2em;
      font-weight: bold;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }
    
    tbody tr {
      transition: background-color 0.3s;
    }
    
    tbody tr:hover {
      background-color: #f5f5f5;
    }
    
    tbody tr:nth-child(even) {
      background-color: #fafafa;
    }
    
    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 1.2em;
    }
    
    .last-update {
      text-align: center;
      color: #666;
      font-size: 0.9em;
      margin-top: 10px;
      font-style: italic;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .updating {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Surveillance des Capteurs</h1>
    
    <div class="stats" id="statsContainer">
      <div class="stat-box">
        <h3>üå°Ô∏è Temp√©rature</h3>
        <div class="value" id="tempValue">--</div>
      </div>
      <div class="stat-box">
        <h3>üíß Humidit√©</h3>
        <div class="value" id="humidValue">--</div>
      </div>
      <div class="stat-box">
        <h3>üî¨ MQ</h3>
        <div class="value" id="mqValue">--</div>
      </div>
    </div>
    
    <div class="card">
      <h2>üìà Graphiques en Temps R√©el</h2>
      <div class="chart-container">
        <canvas id="sheetChart"></canvas>
      </div>
      <div class="last-update" id="lastUpdate">Chargement des donn√©es...</div>
    </div>
    
    <div class="card">
      <h2>üìã Donn√©es R√©centes</h2>
      <div style="overflow-x: auto;">
        <table id="sheetTable">
          <thead>
            <tr>
              <th>Horodatage</th>
              <th>Temp√©rature (¬∞C)</th>
              <th>Humidit√© (%)</th>
              <th>MQ (%)</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="4" class="loading">Chargement des donn√©es...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQwJjy2KpJJ5X--C87zVuPjykAg9Fyc79zIxpdk1Dt0FvrxYw1Onfzt5wSHOVagvLry9uyyohzeN3h4/pub?output=csv';
    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(sheetUrl);

    let chart;

    async function loadSheetData() {
      console.log("Actulisation Data")
      try {
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error('Erreur r√©seau');

        const csvText = await response.text();
        const rows = csvText.trim().split('\n').map(row => {
          return row.split(',').map(cell => cell.trim());
        });

        // Ignorer la ligne d'en-t√™te
        const dataRows = rows.slice(1);

        // Mise √† jour du tableau
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = dataRows
          .slice(-10) // Afficher les 10 derni√®res lignes
          .reverse() // Plus r√©cent en premier
          .map(row => `
            <tr>
              <td>${row[0]}</td>
              <td>${row[1]}</td>
              <td>${row[2]}</td>
              <td>${row[3]}</td>
            </tr>
          `).join('');

        // Mise √† jour des statistiques (derni√®re valeur)
        if (dataRows.length > 0) {
          const lastRow = dataRows[dataRows.length - 1];
          document.getElementById('tempValue').textContent = lastRow[1] + '¬∞C';
          document.getElementById('humidValue').textContent = lastRow[2] + '%';
          document.getElementById('mqValue').textContent = lastRow[3] + '%';
        }

        // Pr√©parer les donn√©es pour le graphique
        const labels = dataRows.map(r => r[0]);
        const tempData = dataRows.map(r => parseFloat(r[1]) || 0);
        const humidData = dataRows.map(r => parseFloat(r[2]) || 0);
        const mqData = dataRows.map(r => parseFloat(r[3]) || 0);

        const ctx = document.getElementById('sheetChart').getContext('2d');

        if (chart) {
          chart.data.labels = labels;
          chart.data.datasets[0].data = tempData;
          chart.data.datasets[1].data = humidData;
          chart.data.datasets[2].data = mqData;
          chart.update('none'); // Pas d'animation lors des mises √† jour
        } else {
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'Temp√©rature (¬∞C)',
                  data: tempData,
                  borderColor: 'rgb(255, 99, 132)',
                  backgroundColor: 'rgba(255, 99, 132, 0.1)',
                  tension: 0.4,
                  borderWidth: 2
                },
                {
                  label: 'Humidit√© (%)',
                  data: humidData,
                  borderColor: 'rgb(54, 162, 235)',
                  backgroundColor: 'rgba(54, 162, 235, 0.1)',
                  tension: 0.4,
                  borderWidth: 2
                },
                {
                  label: 'MQ (%)',
                  data: mqData,
                  borderColor: 'rgb(75, 192, 192)',
                  backgroundColor: 'rgba(75, 192, 192, 0.1)',
                  tension: 0.4,
                  borderWidth: 2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                },
                tooltip: {
                  enabled: true,
                  backgroundColor: 'rgba(0,0,0,0.8)',
                  padding: 12,
                  cornerRadius: 8
                }
              },
              scales: {
                x: {
                  display: true,
                  title: {
                    display: true,
                    text: 'Horodatage'
                  },
                  ticks: {
                    maxTicksLimit: 10
                  }
                },
                y: {
                  display: true,
                  title: {
                    display: true,
                    text: 'Valeur'
                  }
                }
              }
            }
          });
        }

        // Mise √† jour du timestamp
        const now = new Date();
        document.getElementById('lastUpdate').textContent = 
          `Derni√®re mise √† jour : ${now.toLocaleTimeString('fr-FR')}`;

      } catch (err) {
        console.error('Erreur lors du chargement du Google Sheet:', err);
        document.getElementById('tableBody').innerHTML = 
          '<tr><td colspan="4" style="color: red; text-align: center;">Erreur de chargement des donn√©es</td></tr>';
      }
    }

    // Chargement initial
    loadSheetData();
    
    // Rafra√Æchissement automatique toutes les 10 secondes
    setInterval(loadSheetData, 1000);
  </script>
</body>
</html>
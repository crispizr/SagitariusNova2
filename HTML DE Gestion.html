<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Serre Intelligente - Monitoring</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 2.8em;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .status-bar {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 25px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-dot.online {
      background: #10b981;
      box-shadow: 0 0 10px #10b981;
    }
    
    .status-dot.offline {
      background: #ef4444;
      box-shadow: 0 0 10px #ef4444;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .card {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    
    .card h2 {
      color: #1e3c72;
      margin-bottom: 20px;
      font-size: 1.6em;
      border-bottom: 3px solid #7e22ce;
      padding-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .stat-box::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
      50% { transform: translate(-30%, -30%) rotate(180deg); }
    }
    
    .stat-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    
    .stat-box .icon {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .stat-box h3 {
      font-size: 0.95em;
      opacity: 0.95;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }
    
    .stat-box .value {
      font-size: 2.5em;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .stat-box .trend {
      font-size: 0.85em;
      margin-top: 8px;
      opacity: 0.9;
    }
    
    .alert {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .alert.warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 4px solid #f59e0b;
    }
    
    .alert.danger {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }
    
    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid #10b981;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 14px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    th {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.8px;
    }
    
    tbody tr {
      transition: background-color 0.2s;
    }
    
    tbody tr:hover {
      background-color: #f3f4f6;
    }
    
    tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }
    
    .chart-container {
      position: relative;
      height: 450px;
      margin-top: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      color: #6b7280;
      font-size: 1.1em;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    .last-update {
      text-align: center;
      color: #6b7280;
      font-size: 0.9em;
      margin-top: 15px;
      font-style: italic;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9em;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(102, 126, 234, 0.5);
    }
    
    @media (max-width: 768px) {
      h1 { font-size: 2em; }
      .stats { grid-template-columns: 1fr; }
      .chart-container { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üå± Serre Intelligente</h1>
      <p class="subtitle">Surveillance et Contr√¥le en Temps R√©el</p>
    </header>
    
    <div class="status-bar">
      <div class="status-item">
        <div class="status-dot online" id="statusDot"></div>
        <span id="statusText">Syst√®me en ligne</span>
      </div>
      <div class="status-item">
        <span>üì°</span>
        <span id="dataCount">0 mesures</span>
      </div>
      <div class="status-item">
        <span>üïê</span>
        <span id="lastUpdate">En attente...</span>
      </div>
    </div>
    
    <div id="alertsContainer"></div>
    
    <div class="stats" id="statsContainer">
      <div class="stat-box">
        <div class="icon">üå°Ô∏è</div>
        <h3>TEMP√âRATURE</h3>
        <div class="value" id="tempValue">--</div>
        <div class="trend" id="tempTrend"></div>
      </div>
      <div class="stat-box">
        <div class="icon">üíß</div>
        <h3>HUMIDIT√â</h3>
        <div class="value" id="humidValue">--</div>
        <div class="trend" id="humidTrend"></div>
      </div>
      <div class="stat-box">
        <div class="icon">üî¨</div>
        <h3>GAZ (MQ)</h3>
        <div class="value" id="mqValue">--</div>
        <div class="trend" id="mqTrend"></div>
      </div>
    </div>
    
    <div class="card">
      <h2>üìà Graphiques d'√âvolution</h2>
      <div class="controls">
        <button class="btn btn-primary" onclick="changeTimeRange(10)">10 derni√®res</button>
        <button class="btn btn-primary" onclick="changeTimeRange(50)">50 derni√®res</button>
        <button class="btn btn-primary" onclick="changeTimeRange(100)">100 derni√®res</button>
        <button class="btn btn-primary" onclick="loadSheetData()">üîÑ Actualiser</button>
      </div>
      <div class="chart-container">
        <canvas id="sheetChart"></canvas>
      </div>
    </div>
    
    <div class="card">
      <h2>üìã Historique des Donn√©es</h2>
      <div style="overflow-x: auto;">
        <table id="sheetTable">
          <thead>
            <tr>
              <th>üìÖ Horodatage</th>
              <th>üå°Ô∏è Temp√©rature (¬∞C)</th>
              <th>üíß Humidit√© (%)</th>
              <th>üî¨ MQ (%)</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="4" class="loading">Chargement des donn√©es</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQwJjy2KpJJ5X--C87zVuPjykAg9Fyc79zIxpdk1Dt0FvrxYw1Onfzt5wSHOVagvLry9uyyohzeN3h4/pub?output=csv';
    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(sheetUrl);

    let chart;
    let allData = [];
    let displayRange = 50;
    let previousValues = { temp: null, humid: null, mq: null };

    const THRESHOLDS = {
      temp: { min: 15, max: 30, optimal: [20, 25] },
      humid: { min: 40, max: 80, optimal: [50, 70] },
      mq: { max: 30 }
    };

    async function loadSheetData() {
      try {
        document.getElementById('statusText').textContent = 'Chargement...';
        
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error('Erreur r√©seau');

        const csvText = await response.text();
        const rows = csvText.trim().split('\n').map(row => {
          return row.split(',').map(cell => cell.trim());
        });

        allData = rows.slice(1);
        
        updateStatus(true);
        updateTable();
        updateStats();
        updateChart();
        checkAlerts();
        
        const now = new Date();
        document.getElementById('lastUpdate').textContent = 
          now.toLocaleTimeString('fr-FR');

      } catch (err) {
        console.error('Erreur:', err);
        updateStatus(false);
        document.getElementById('tableBody').innerHTML = 
          '<tr><td colspan="4" style="color: red; text-align: center;">‚ùå Erreur de chargement</td></tr>';
      }
    }

    function updateStatus(online) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      
      if (online) {
        dot.className = 'status-dot online';
        text.textContent = 'Syst√®me en ligne';
        document.getElementById('dataCount').textContent = `${allData.length} mesures`;
      } else {
        dot.className = 'status-dot offline';
        text.textContent = 'Syst√®me hors ligne';
      }
    }

    function updateTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = allData
        .slice(-20)
        .reverse()
        .map(row => `
          <tr>
            <td>${row[0]}</td>
            <td>${row[1]}¬∞C</td>
            <td>${row[2]}%</td>
            <td>${row[3]}%</td>
          </tr>
        `).join('');
    }

    function updateStats() {
      if (allData.length === 0) return;
      
      const lastRow = allData[allData.length - 1];
      const temp = parseFloat(lastRow[1]);
      const humid = parseFloat(lastRow[2]);
      const mq = parseFloat(lastRow[3]);
      
      document.getElementById('tempValue').textContent = temp.toFixed(1) + '¬∞C';
      document.getElementById('humidValue').textContent = humid.toFixed(1) + '%';
      document.getElementById('mqValue').textContent = mq.toFixed(1) + '%';
      
      updateTrend('temp', temp, previousValues.temp);
      updateTrend('humid', humid, previousValues.humid);
      updateTrend('mq', mq, previousValues.mq);
      
      previousValues = { temp, humid, mq };
    }

    function updateTrend(type, current, previous) {
      if (previous === null) return;
      
      const diff = current - previous;
      const arrow = diff > 0 ? '‚Üë' : diff < 0 ? '‚Üì' : '‚Üí';
      const color = diff > 0 ? '#10b981' : diff < 0 ? '#ef4444' : '#6b7280';
      
      const trendEl = document.getElementById(`${type}Trend`);
      trendEl.innerHTML = `<span style="color: ${color}">${arrow} ${Math.abs(diff).toFixed(1)}</span>`;
    }

    function checkAlerts() {
      const alertsContainer = document.getElementById('alertsContainer');
      alertsContainer.innerHTML = '';
      
      if (allData.length === 0) return;
      
      const lastRow = allData[allData.length - 1];
      const temp = parseFloat(lastRow[1]);
      const humid = parseFloat(lastRow[2]);
      const mq = parseFloat(lastRow[3]);
      
      if (temp > THRESHOLDS.temp.max) {
        addAlert('danger', 'üö® Temp√©rature trop √©lev√©e !', `${temp.toFixed(1)}¬∞C > ${THRESHOLDS.temp.max}¬∞C`);
      } else if (temp < THRESHOLDS.temp.min) {
        addAlert('warning', '‚ö†Ô∏è Temp√©rature basse', `${temp.toFixed(1)}¬∞C < ${THRESHOLDS.temp.min}¬∞C`);
      }
      
      if (humid < THRESHOLDS.humid.min) {
        addAlert('warning', '‚ö†Ô∏è Humidit√© faible', `${humid.toFixed(1)}% < ${THRESHOLDS.humid.min}%`);
      } else if (humid > THRESHOLDS.humid.max) {
        addAlert('danger', 'üö® Humidit√© trop √©lev√©e !', `${humid.toFixed(1)}% > ${THRESHOLDS.humid.max}%`);
      }
      
      if (mq > THRESHOLDS.mq.max) {
        addAlert('danger', 'üö® Niveau de gaz √©lev√© !', `Qualit√© de l'air d√©grad√©e`);
      }
      
      if (alertsContainer.children.length === 0) {
        addAlert('success', '‚úì Tous les param√®tres sont normaux', '');
      }
    }

    function addAlert(type, title, detail) {
      const alertsContainer = document.getElementById('alertsContainer');
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.innerHTML = `<strong>${title}</strong> ${detail}`;
      alertsContainer.appendChild(alert);
    }

    function updateChart() {
      const displayData = allData.slice(-displayRange);
      
      const labels = displayData.map(r => r[0]);
      const tempData = displayData.map(r => parseFloat(r[1]) || 0);
      const humidData = displayData.map(r => parseFloat(r[2]) || 0);
      const mqData = displayData.map(r => parseFloat(r[3]) || 0);

      const ctx = document.getElementById('sheetChart').getContext('2d');

      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = tempData;
        chart.data.datasets[1].data = humidData;
        chart.data.datasets[2].data = mqData;
        chart.update('none');
      } else {
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Temp√©rature (¬∞C)',
                data: tempData,
                borderColor: 'rgb(239, 68, 68)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6
              },
              {
                label: 'Humidit√© (%)',
                data: humidData,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6
              },
              {
                label: 'MQ (%)',
                data: mqData,
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 13, weight: 'bold' },
                  padding: 15
                }
              },
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: 15,
                cornerRadius: 10,
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 13 }
              }
            },
            scales: {
              x: {
                display: true,
                title: {
                  display: true,
                  text: 'Horodatage',
                  font: { size: 13, weight: 'bold' }
                },
                ticks: { maxTicksLimit: 15 }
              },
              y: {
                display: true,
                title: {
                  display: true,
                  text: 'Valeur',
                  font: { size: 13, weight: 'bold' }
                }
              }
            }
          }
        });
      }
    }

    function changeTimeRange(range) {
      displayRange = range;
      updateChart();
    }

    loadSheetData();
    setInterval(loadSheetData, 10000);
  </script>
</body>
</html>

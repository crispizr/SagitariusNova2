<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Priva Climate Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #0f1117; color: #f8f9fa; }
    .header { background: linear-gradient(135deg, #0066cc, #004999); padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .logo { display: flex; align-items: center; gap: 15px; }
    .logo h1 { color: white; font-size: 24px; }
    .status-bar { display: flex; gap: 20px; }
    .status-item { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 20px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #00a651; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
    .card { background: #1a1d29; border-radius: 15px; padding: 25px; border: 1px solid #2d3142; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2d3142; }
    .card-title { font-size: 18px; font-weight: 600; }
    .sensor-card { background: linear-gradient(135deg, #1a1d29, #252836); border-radius: 15px; padding: 25px; text-align: center; border: 1px solid #2d3142; transition: transform 0.3s; }
    .sensor-card:hover { transform: translateY(-5px); }
    .sensor-icon { font-size: 40px; margin-bottom: 15px; }
    .sensor-value { font-size: 36px; font-weight: 700; color: white; }
    .sensor-unit { font-size: 18px; color: rgba(248,249,250,0.6); }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .status-badge.optimal { background: rgba(0,166,81,0.2); color: #00a651; }
    .status-badge.warning { background: rgba(247,127,0,0.2); color: #f77f00; }
    .status-badge.critical { background: rgba(230,57,70,0.2); color: #e63946; }
    .device-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .device-card { background: #0f1117; border: 2px solid #2d3142; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .device-card:hover { border-color: #0066cc; }
    .device-card.active { background: linear-gradient(135deg, #0066cc, #004999); border-color: #0066cc; }
    .device-icon { font-size: 32px; margin-bottom: 10px; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 5px; }
    .btn-primary { background: #0066cc; color: white; }
    .btn-success { background: #00a651; color: white; }
    .btn-danger { background: #e63946; color: white; }
    .btn:hover { transform: translateY(-2px); opacity: 0.9; }
    .alert { padding: 15px 20px; border-radius: 10px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
    .alert.success { background: rgba(0,166,81,0.15); border-left: 4px solid #00a651; color: #6fdc8c; }
    .alert.warning { background: rgba(247,127,0,0.15); border-left: 4px solid #f77f00; color: #ffb347; }
    .alert.danger { background: rgba(230,57,70,0.15); border-left: 4px solid #e63946; color: #ff6b6b; }
    .chart-container { position: relative; height: 350px; margin-top: 20px; }
    .control-group { margin-bottom: 20px; }
    .control-label { font-size: 13px; margin-bottom: 10px; display: block; }
    .slider { width: 100%; height: 6px; border-radius: 3px; background: #2d3142; outline: none; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #0066cc; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #2d3142; }
    th { background: #0f1117; font-size: 12px; text-transform: uppercase; }
    tbody tr:hover { background: #0f1117; }
    @media (max-width: 768px) { .grid-2, .grid-4 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo">
        <h1>🌱 PRIVA Climate Control</h1>
      </div>
      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot"></div>
          <span>Système actif</span>
        </div>
        <div class="status-item">
          <span>📡 <strong id="dataCount">0</strong> mesures</span>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="alertContainer"></div>

    <div class="grid-4">
      <div class="sensor-card">
        <div class="sensor-icon">🌡️</div>
        <div class="sensor-value"><span id="tempValue">--</span><span class="sensor-unit">°C</span></div>
        <div style="margin-top:10px"><span class="status-badge optimal" id="tempStatus">Optimal</span></div>
      </div>
      <div class="sensor-card">
        <div class="sensor-icon">💧</div>
        <div class="sensor-value"><span id="humidValue">--</span><span class="sensor-unit">%</span></div>
        <div style="margin-top:10px"><span class="status-badge optimal" id="humidStatus">Optimal</span></div>
      </div>
      <div class="sensor-card">
        <div class="sensor-icon">🔬</div>
        <div class="sensor-value"><span id="gasValue">--</span><span class="sensor-unit">ppm</span></div>
        <div style="margin-top:10px"><span class="status-badge optimal" id="gasStatus">Bon</span></div>
      </div>
      <div class="sensor-card">
        <div class="sensor-icon">☀️</div>
        <div class="sensor-value"><span id="lightValue">--</span><span class="sensor-unit">lux</span></div>
        <div style="margin-top:10px"><span class="status-badge optimal">Optimal</span></div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">⚙️ Équipements</div>
        </div>
        <div class="device-grid">
          <div class="device-card" id="pumpCard" onclick="toggleDevice('pump')">
            <div class="device-icon">💧</div>
            <div>Irrigation</div>
            <small>Arrêté</small>
          </div>
          <div class="device-card" id="mistCard" onclick="toggleDevice('mist')">
            <div class="device-icon">💦</div>
            <div>Brumisation</div>
            <small>Arrêté</small>
          </div>
          <div class="device-card" id="fanCard" onclick="toggleDevice('fan')">
            <div class="device-icon">🌀</div>
            <div>Ventilation</div>
            <small>Arrêté</small>
          </div>
          <div class="device-card" id="heatCard" onclick="toggleDevice('heat')">
            <div class="device-icon">🔥</div>
            <div>Chauffage</div>
            <small>Arrêté</small>
          </div>
          <div class="device-card" id="lightCard" onclick="toggleDevice('light')">
            <div class="device-icon">💡</div>
            <div>Éclairage</div>
            <small>Arrêté</small>
          </div>
          <div class="device-card" id="valveCard" onclick="toggleDevice('valve')">
            <div class="device-icon">🚰</div>
            <div>Électrovanne</div>
            <small>Fermée</small>
          </div>
        </div>
        <div style="margin-top:20px">
          <button class="btn btn-success" onclick="setMode('auto')">🤖 Auto</button>
          <button class="btn btn-primary" onclick="setMode('manual')">✋ Manuel</button>
          <button class="btn btn-danger" onclick="emergencyStop()">🛑 Arrêt</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">🎯 Paramètres</div>
        </div>
        <div class="control-group">
          <label class="control-label">🌡️ Température Min: <span id="tempMinVal">18°C</span></label>
          <input type="range" min="10" max="25" value="18" class="slider" id="tempMin" oninput="updateSlider('tempMin',this.value,'°C')">
        </div>
        <div class="control-group">
          <label class="control-label">🌡️ Température Max: <span id="tempMaxVal">28°C</span></label>
          <input type="range" min="20" max="40" value="28" class="slider" id="tempMax" oninput="updateSlider('tempMax',this.value,'°C')">
        </div>
        <div class="control-group">
          <label class="control-label">💧 Humidité Min: <span id="humidMinVal">50%</span></label>
          <input type="range" min="30" max="70" value="50" class="slider" id="humidMin" oninput="updateSlider('humidMin',this.value,'%')">
        </div>
        <div class="control-group">
          <label class="control-label">💧 Humidité Max: <span id="humidMaxVal">80%</span></label>
          <input type="range" min="50" max="95" value="80" class="slider" id="humidMax" oninput="updateSlider('humidMax',this.value,'%')">
        </div>
        <button class="btn btn-success" style="width:100%" onclick="saveSettings()">💾 Enregistrer</button>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">📈 Température & Humidité</div>
        </div>
        <div class="chart-container">
          <canvas id="climateChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">📊 Qualité Air</div>
        </div>
        <div class="chart-container">
          <canvas id="airChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">📋 Données Récentes</div>
      </div>
      <table>
        <thead>
          <tr><th>Date</th><th>Temp</th><th>Humid</th><th>CO2</th><th>Statut</th></tr>
        </thead>
        <tbody id="dataTable">
          <tr><td colspan="5" style="text-align:center">Chargement...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQwJjy2KpJJ5X--C87zVuPjykAg9Fyc79zIxpdk1Dt0FvrxYw1Onfzt5wSHOVagvLry9uyyohzeN3h4/pub?output=csv';
    const PROXY = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(SHEET_URL);
    let climateChart, airChart, allData = [];
    const devices = {pump:false, mist:false, fan:false, heat:false, light:false, valve:false};
    const THRESH = {temp:{min:18,max:28},humid:{min:50,max:80},gas:{max:800}};

    function init() {
      setupCharts();
      loadData();
      setInterval(loadData, 10000);
    }

    function setupCharts() {
      const opts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#f8f9fa' } } },
        scales: {
          x: { ticks: { color: '#9ca3af' }, grid: { color: '#2d3142' } },
          y: { ticks: { color: '#9ca3af' }, grid: { color: '#2d3142' } }
        }
      };

      climateChart = new Chart(document.getElementById('climateChart'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'Température', data: [], borderColor: '#ef4444', tension: 0.4, borderWidth: 3 },
            { label: 'Humidité', data: [], borderColor: '#3b82f6', tension: 0.4, borderWidth: 3 }
          ]
        },
        options: opts
      });

      airChart = new Chart(document.getElementById('airChart'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{ label: 'CO2', data: [], borderColor: '#10b981', tension: 0.4, borderWidth: 3, fill: true }]
        },
        options: opts
      });
    }

    async function loadData() {
      try {
        const res = await fetch(PROXY);
        const csv = await res.text();
        const rows = csv.trim().split('\n').map(r => r.split(',').map(c => c.trim()));
        allData = rows.slice(1);
        
        if (allData.length > 0) {
          updateUI();
          document.getElementById('dataCount').textContent = allData.length;
        }
      } catch (err) {
        console.error('Erreur:', err);
        showAlert('danger', '❌ Erreur de chargement');
      }
    }

    function updateUI() {
      const last = allData[allData.length - 1];
      const temp = parseFloat(last[1]);
      const humid = parseFloat(last[2]);
      const gas = parseFloat(last[3]) * 10;

      document.getElementById('tempValue').textContent = temp.toFixed(1);
      document.getElementById('humidValue').textContent = humid.toFixed(1);
      document.getElementById('gasValue').textContent = gas.toFixed(0);
      document.getElementById('lightValue').textContent = Math.floor(Math.random()*30000+20000);

      updateStatus('temp', temp);
      updateStatus('humid', humid);
      updateStatus('gas', gas);
      updateCharts();
      updateTable();
      checkAlerts(temp, humid, gas);
    }

    function updateStatus(type, val) {
      const el = document.getElementById(type + 'Status');
      const t = THRESH[type];
      if (type === 'gas') {
        el.textContent = val > t.max ? 'Élevé' : 'Bon';
        el.className = 'status-badge ' + (val > t.max ? 'critical' : 'optimal');
      } else {
        if (val < t.min || val > t.max) {
          el.textContent = val < t.min ? 'Bas' : 'Élevé';
          el.className = 'status-badge ' + (val < t.min ? 'warning' : 'critical');
        } else {
          el.textContent = 'Optimal';
          el.className = 'status-badge optimal';
        }
      }
    }

    function updateCharts() {
      const data = allData.slice(-50);
      const labels = data.map(r => r[0]);
      const temps = data.map(r => parseFloat(r[1]));
      const humids = data.map(r => parseFloat(r[2]));
      const gases = data.map(r => parseFloat(r[3]) * 10);

      climateChart.data.labels = labels;
      climateChart.data.datasets[0].data = temps;
      climateChart.data.datasets[1].data = humids;
      climateChart.update('none');

      airChart.data.labels = labels;
      airChart.data.datasets[0].data = gases;
      airChart.update('none');
    }

    function updateTable() {
      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = allData.slice(-10).reverse().map(r => `
        <tr>
          <td>${r[0]}</td>
          <td>${r[1]}°C</td>
          <td>${r[2]}%</td>
          <td>${(parseFloat(r[3])*10).toFixed(0)} ppm</td>
          <td><span class="status-badge optimal">Normal</span></td>
        </tr>
      `).join('');
    }

    function checkAlerts(temp, humid, gas) {
      const alerts = document.getElementById('alertContainer');
      alerts.innerHTML = '';
      
      if (temp > THRESH.temp.max) showAlert('danger', '🚨 Température élevée: ' + temp.toFixed(1) + '°C');
      if (temp < THRESH.temp.min) showAlert('warning', '⚠️ Température basse: ' + temp.toFixed(1) + '°C');
      if (humid < THRESH.humid.min) showAlert('warning', '⚠️ Humidité basse: ' + humid.toFixed(1) + '%');
      if (humid > THRESH.humid.max) showAlert('danger', '🚨 Humidité élevée: ' + humid.toFixed(1) + '%');
      if (gas > THRESH.gas.max) showAlert('danger', '🚨 CO2 élevé: ' + gas.toFixed(0) + ' ppm');
      
      if (alerts.children.length === 0) showAlert('success', '✓ Tous les paramètres sont optimaux');
    }

    function showAlert(type, msg) {
      const alerts = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = 'alert ' + type;
      alert.innerHTML = msg;
      alerts.appendChild(alert);
    }

    function toggleDevice(device) {
      devices[device] = !devices[device];
      const card = document.getElementById(device + 'Card');
      if (devices[device]) {
        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
      console.log('Device', device, devices[device] ? 'ON' : 'OFF');
    }

    function setMode(mode) {
      console.log('Mode:', mode);
      showAlert('success', '✓ Mode ' + mode + ' activé');
    }

    function emergencyStop() {
      Object.keys(devices).forEach(d => {
        devices[d] = false;
        document.getElementById(d + 'Card').classList.remove('active');
      });
      showAlert('danger', '🛑 Arrêt d\'urgence activé');
    }

    function updateSlider(id, val, unit) {
      document.getElementById(id + 'Val').textContent = val + unit;
    }

    function saveSettings() {
      const settings = {
        tempMin: document.getElementById('tempMin').value,
        tempMax: document.getElementById('tempMax').value,
        humidMin: document.getElementById('humidMin').value,
        humidMax: document.getElementById('humidMax').value
      };
      console.log('Paramètres sauvegardés:', settings);
      showAlert('success', '💾 Paramètres enregistrés');
    }

    init();
  </script>
</body>
</html>
